name: Release Docker Image

on:
  push:
    branches: [ dev ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      
    - name: Login to Docker
      run: docker login -u "${DOCKER_HUB_USERNAME}" -p "${DOCKER_HUB_TOKEN}"
      env: 
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Use example environment file
      run: cp .env.example .env

    - name: Build the Backend Docker image
      run: docker-compose -f docker-compose.ci.yml build --parallel backend generator manager frontend
      
    - name: Tag the Generator Docker image
      run: docker tag cockpit-generator udopigorsch/workload_generator
    - name: Push the Backend Docker image
      run: docker push cockpit-backend udopigorsch/cockpit-backend

    - name: Tag the Generator Docker image
      run: docker tag cockpit-generator udopigorsch/workload_generator
    - name: Push the Generator Docker image
      run: docker push cockpit-generator udopigorsch/cockpit-generator

    - name: Tag the Manager Docker image
      run: docker tag cockpit-manager udopigorsch/database_manager
    - name: Push Manager Docker image
      run: docker push cockpit-manager udopigorsch/cockpit-manager
   
    - name: Tag the Frontend Docker image
      run: docker tag cockpit-frontend udopigorsch/frontend
    - name: Push the Frontend Docker image
      run: docker push cockpit-frontend udopigorsch/cockpit-frontend
